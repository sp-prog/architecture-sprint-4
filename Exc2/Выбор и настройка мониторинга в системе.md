# Мотивация

Мониторинг, логирование и трассировка улучшат наблюдаемость продукта.
Увеличение наблюдаемости позволит:
- упросить исправление ошибок, замеченных пользователями
- исправлять оперативно ошибки, не замеченные пользователями. К незамечанным ошибкам также относятся
ошибки, которые пользователь заметил, но в результате быстрого исправления отнес их к "глюкам"
не связанным с продуктом, например "интернет глючит"
- оперативно реагировать на нештатные ситуации, такие как, например внезапное увеличение нагрузки
на сервера, вышедший из строя узел кластера, сетевеы проблемы и т.д.
- собрирать аналитические данные о пользователях системы и принимать бизнес-решения
для увеличение прибыли или уменьшения убытков (прогнозирование рисков).


Все это в свою очередь позволит уменьшить недовольсьво пользователей и финансовые потери компании

# Выбор подхода к мониторингу

С MES-API следует собирать сразу два типа метрик:
- метрики из USE: утилизация, насыщенность и ошибки - для мониторинга за задачами расчета изделия
- метрики золотого сигнала от гугла для мониторинга трафика

С Shop API и CRM API следует собирать метрики золотого сигнала от гугла для мониторинга трафика

С брокера сообщений и баз данных следует собирать метрики RED для выявления проблем производительности.
Это позволит быстрее заметить непотимальные запросы к БД и заканчивающиеся аппаратные ресурсы
брокера и БД

С файлового хранилища следует собирать метрики USE, т.к. обычно файловые операции потребляют много
ресурсов, а при отсутствии механизма удаления утаревших данных потребленные ресурсы не восполняются
автоматически

# Метрики, для отслеживани

## RabbitMq

Number of message in flight in RabbitMQ - отслеживание количества отправленных, но еще не полученных
сообщений. Необходимо отслеживать для предотвращения переполнения очередей брокера сообщений.

Number of dead-letter-exchange letters in RabbitMQ - количество сообщений, которые невозможно доставить.
Метрика указывает на проблемы с доставкой, с кластером брокера или просроченной доставкой.
Накопление таких сообщений говорит о проблемах обработки или доставки собщений. Любое из таких сообщений
может быть причиной потери заказа.

Number of HTTP 500 for shop API - метрика необходима для быстрого обнаружения проблем у пользователя
продукта. Чем больше таких ошибок тем больше недовольство пользователей. Их всплеск может говорить
о проблемах с новыми версиями ПО или неожиданными действия пользователей

Response time (latency) for shop API
Number of simultanious sessions for shop API
Kb tranferred (received) for shop API
Kb provided (sent) for shop API

Эти метрики необходимы для соеврменного обнаружения повышенной нагрузки на сервисы.

## Shop API

Number of requests (RPS) for internet shop API - количество запросов в секунду. Слежение за метрикой
необходимо для своевременного реагирования на увеличение нагрузки на онлайн-магазин. Т.к. данный
продкут предназначен для привлечения как можно большего количества клиентов и открыт для всех
пользователей интернета, то повышенная нагрузка может значит или распродажу или попытку аттаки.

Number of requests (RPS) per user for internet shop API - количество запросов в секунду на одного
пользователя. Тоже что и выше, но в этом случае пользователя можно автоматически или вручную
заблокировать

## CRM API

Предположим, что доступк с CRM взоможен только изнутри сети компании. Тогда на мониторингах можно
сэкономить первое время. Но в послдествии лучше добавить:

CPU % for CRM API
Memory Utilisation for CRM API
Response time (latency) for CRM API
Size of shop db instance
Number of HTTP 500 for CRM API

Все это необходимо для выявления ситуаций сбоев оборудования или последствий обновления ПО.
Возможно еще несанкционированный доступ. Но в большинстве случаев для закрытых ресурсов внезапно
выросшее потребление ресурсов говорит о проблемах с новыми версиями ПО

## MES API

CPU % for MES API - утилизация ресурса ЦПУ. Необходимо отслеживать, т.к., судя по времени работы,
процесс расчета по модели ресурсоемкий и сильно утилизирует ресурс процессора. При привышении
порогового значения микросервис может быть принудительно перезапущен механизмом управления кластером.
Для предупреждения таких ситуаций необходимо мониторинг, который позволит вовремя выделить доп.ресурсы

Memory Utilisation for MES API - утилизация памяти. Причины те же, что и выше

Number of requests (RPS) per user for MES API
Response time (latency) for MES API
Number of HTTP 500 for MES API
Number of simultanious sessions for MES API

Эти метрики необходимы для выявления проблем с производительностью MES и обнаружения избыточной нагрузки
создаваемой клиентами API

# File Storage

Size of S3 storage - размер файлового хранилиза. Метрика необходима для своевременного увеличения
объема дискового пространства под файлы хранилища. Если место закончится, то невозможно будет принимать
новые заказы, от чего напрямую зависит прибыль компании

## db 

Memory Utilisation for shop db instance
Memory Utilisation for MES db instance
Number of connections for shop db instance
Number of connections for MES db instance
Size of shop db instance
Size of MES db instance

Метрики утилизации памяти, количество открытых соединений и размер БД необходимо наблюдать, т.к.:
- при нехватке памяти БД будет дольше выполнять запросы
- при превышении объема дискового пространства БД может выйти из строя и ее сложно будет восстановить.
В результате остановится работа соответствующего продукта
- при превышении количества одновременных соединений определенного значение СУБД может отвергать 
новые соединения. В результате чего пользователи будут получать ошибюи при работе с продкутом

# План действий

Т.к. OpenTelemetry - универсальная библиотека для работы с любыми собирателями метрик, реализация
поторой есть на java и на C# то для внедрения метрик в приложения лучше выбрать ее.
Первоначально необходимо создать задачу на исследование внедрения мониторинга. Для проведения исследования
подойдет CRM. Т.к. это внутренний ресурс, который можно незаметно для покупателей откатить.

В выбранное приложение необходимо подключить OpenTelemetry, проверить его работу на локальном
компьютере разработчика в docker'е с запущенными серверами сбора метрик. Потом проверить не поменяется
ли поведение, если сервер сбора метрик будет недоступен. Если все будет хорошо, то версию с метриками
можно выпускать в релиз, а devops'ам поручить задачу настройки серверов сбора метрик на тестовом стенде.
После настройки сборщика метрик необходимо настроить отображение.

После настройки серверов необходимо проверить сбор метрик на тестовом стенде. Если все работает,
то разворачивать сборщики метрик на проде.
Затем все тоже самое сделать на MES API и на онлайн-магазине.

Для хранения метрик можно использовать prometheus. Чтобы не хранить метрики на стороне приложения,
можно сделать push-server prometheus'а на первое время или заменить весь prometheus на victoriametrics
Для отображения Grafana'у.

Первое время все это можно настроить в docker'е. Но это опасно тем, что ВР (временное решение)
частенько превращается в ВР (вечное решение). Т.ч. лучше делать сразу капитально

К каждой метрике необходимо задать пороговые занчение, при пересечении которых ответственным лицам будут приходить уведомления.

