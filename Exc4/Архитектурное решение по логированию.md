# Сбор логов

Для наблюдения за работоспособностью системы необходимо собирать логи о всех ошибках (ERROR). Превышения типичного значения количества ошибок в единицу времени может говорить о возникающих проблемах.

Любая ошибка уровная FATAL является признаком серьезной проблемы в сервисе, который ее отправил

Любые события, которые прерывают выполнение программы вне рамок описанного для данной программы (функциии) процесса выполнения должны отмечаться как ERROR. Например, попытка просмотра списка заказов неваторизованным пользователем, все 400 и 500 http-коды ответов, все возникающие необработанные исключения.

Все события, которые не прерывают выполнение программы (функции), но являются неожиданными должны помечаться как WARNING, например при пакетной рассылки сообщений пользователям на мобильные устройства у нескольких зарегистрированных пользователей оказывается не валидные адреса доставки. Рассыка не останавливается, а в лог пишется warning

Под уровень логирования INFO обычно попадают сообщения, помогающие восстановить цеполчку событий от начала выполнения некой задачи (запроса, функции и тд) до ее завершения. Обычно это:
- запись о начале запроса со всеми входными данными, кроме "чувствительных" и боольших (файлов). Например запросы к АПИ, запросы к БД, запросы к брокеру и файловому хранилищу
- запись о завершении запроса со всеми выходными данными, кроме "чувствительных" и боольших (файлов). Те же что в пункте выше
- запись о изменении состояния данных, например, смена статуса обработки заказа на любом этапе, отправка нового файла в файловое хранилище, начало и окончание расчета модели, вход и выход пользователя из приложения и т.д.

Остальные уровни логирования используются для отладки приложений. Они могут замедлять работу приложения и занимать много ресурсов системы хранения логов. Поэтому их на продуктовой среде стоит отключать. Так же они могут содержать чувствительную информацию (TRACE)

# Мотивация 

Для разбора инцидентов и контроля состояния сервисов, неподдерживающих отправку метрик в накопители метрик, необходимо собирать логи со всех сервсов включенных в процесс обработки запроса пользователя или других действий, в том числе автоматических.

Такие логи позволят создать метрики для наблюдения за состоянием сервисов и снизит трудозатраты и время на поиск и исправление причин ошибок. Так же это позволит исправлять и выявлять некоторые ошибки до того, как их заметить конечный пользователь. Так же логирование поможет отслеживать действия пользоватей, что необходимо при разборе инцидентов связанных с  безопаснотью. Отслеживание действий пользователей так же может быть полезно маркетологам для планирования мероприятий и оценки их эффективности.

Первым делом трейсинг и логирование необходимо внедрить на всем пути обработки запросов от MES API, т.к. проблемы с его работой уже привели к потере нескольких крупных контрактов

# Предлагаемое решение

С микросервисов и файлового хранилища необходимо отправлять логи через OpenTelemetry непосредственно в Logstesh по tcp. 

Если файловое хранилище поддерживает только логирование в файлы логов, то следует подключить FileBeat

С брокера сообщений и с баз, скорее-всего, придется собирать логи через FileBeats, т.к. скорее-всего они не поддерживают отправку логов непосредственно в Logstash

Для каждого сервиса необходимо сделать отдельный индекс под логи

# Безопасность

К системе  должен быть доступ только изнутри сети компании для согласованных с отделом безопасности ролей пользователей. Обычно такими ролями являются: поддержка 2ой и 3ей линии. Дежурные разраотчики.

Для большего контроля можно организовать сетевой доступ к серверам только через терминальные сервера Доступ должен предоставляться только под учетными записями сотрудников компании.

# Политики хранения логов

Для определения сроков харения логов необходим анализ действующего законодательсва. Если не брать его в расчеты, то логи должны храниться столько времени, сколько необходимо для разрешения инцидентов. Эти сроки зависят от загруженности команды. Если команда не загружена всегда, то сроки хранения логов записят от скорости, с которой ошибка становится явной после возникновения. Если в системе настроены уведосления об ошибках и нештатных ситуациях, то это время почти стремиться к 0. В результате логи должны храниться 2а спринта: в 1ый - ошибка стала явной, 2ой - разработчик собирает логи, метрики, трейсы, фиксиурет это все в описании ошибки. После этого логи можно удалять.

# Индексы

Все данные, имеющие одинаковую структуру - скорее-всего это данные АПИ - можно сложить в один индекс. Так будет проще собирать цеполчку логов
Данные, имеющие различные структуры лучше положить в разные индексы, иначе они будут мешать сборке цепочки логов.

# Анализ логов

Для настройки уведомлений о нештатных ситуациях используется обычно мониторинг. На долю логирования остаются только сигналы об отклонении поведения пользователя от того, которое было построено на истории его общения с сервисами. Так же можно настроить отслеживание отклонения количества ошибок от исторических значений, внезапные изменени количества записей в журнале